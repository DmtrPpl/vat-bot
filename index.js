const express = require("express");
const axios = require("axios");
require("dotenv").config();

const app = express();
app.use(express.json());

const { OPENAI_API_KEY, TELEGRAM_BOT_TOKEN, PORT = 3000 } = process.env;

if (!OPENAI_API_KEY || !TELEGRAM_BOT_TOKEN) {
  console.error("‚ùå Missing OPENAI_API_KEY or TELEGRAM_BOT_TOKEN");
  process.exit(1);
}

const TG_API = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}`;
async function tg(method, body) {
  return axios.post(`${TG_API}/${method}`, body);
}

// =============== STATE ===============
const store = new Map(); // chatId -> { entries: [], settings: { currency, vatRate } }

function getState(chatId) {
  if (!store.has(chatId)) {
    store.set(chatId, {
      entries: [],
      settings: { currency: "EUR", vatRate: 20 },
    });
  }
  return store.get(chatId);
}

// =============== HELPERS ===============
function toISO(dateLike) {
  if (typeof dateLike === "string" && /^\d{4}-\d{2}-\d{2}$/.test(dateLike))
    return dateLike;
  const d = new Date();
  return d.toISOString().slice(0, 10);
}
function monthOf(dateStr) {
  return dateStr?.slice(0, 7);
}
function yearOf(dateStr) {
  return dateStr?.slice(0, 4);
}
function detectExplicitDate(text) {
  if (!text) return null;
  let m = text.match(/\b(\d{4})-(\d{2})-(\d{2})\b/);
  if (m) return `${m[1]}-${m[2]}-${m[3]}`;
  m = text.match(/\b(\d{2})\.(\d{2})\.(\d{4})\b/);
  if (m) return `${m[3]}-${m[2]}-${m[1]}`;
  return null;
}

function computeTriplet(amount, amountType, vatRate, vatApplicable) {
  const A = Number(amount) || 0;
  const r = vatApplicable ? vatRate / 100 : 0;
  if (r <= 0) return { net: +A.toFixed(2), vat: 0, gross: +A.toFixed(2) };

  if (amountType === "net") {
    const vat = +(A * r).toFixed(2);
    return { net: +A.toFixed(2), vat, gross: +(A + vat).toFixed(2) };
  }
  const net = +(A / (1 + r)).toFixed(2);
  return { net, vat: +(A - net).toFixed(2), gross: +A.toFixed(2) };
}

function quickLines(text) {
  return text
    .split("\n")
    .map((l) => l.trim())
    .filter(Boolean)
    .map((line) => {
      const m = line.match(/^([+-])\s*([\d\s.,]+)\s*([a-zA-Z]{3})?/);
      if (!m) return null;
      const type = m[1] === "+" ? "income" : "expense";
      const amount = parseFloat(
        (m[2] || "").replace(/\s+/g, "").replace(",", ".")
      );
      if (!isFinite(amount)) return null;
      const currency = (m[3] || "").toUpperCase() || null;
      const rest = line.slice(m[0].length).trim();
      return { type, amount, currency, rest, raw: line };
    })
    .filter(Boolean);
}

// =============== AI PROMPT ===============
const systemPrompt = `
–¢–∏ ‚Äî –ø–æ–º—ñ—á–Ω–∏–∫ –∑ –æ–±–ª—ñ–∫—É –ü–î–í –¥–ª—è –§–û–ü.
–ù–∞ –≤—Ö—ñ–¥ –¥–∞—î—Ç—å—Å—è –∫–æ—Ä–æ—Ç–∫–∏–π —Ä—è–¥–æ–∫ —É —Å—Ç–∏–ª—ñ "+1000 eur —Å–∞–π—Ç" –∞–±–æ "-200 —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç –±–µ–∑ –ü–î–í".
–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –ª–∏—à–µ JSON:
{
  "type": "income"|"expense",
  "amount_type": "net"|"gross"|"unknown",
  "vat_applicable": boolean,
  "category": "sales|services|hardware|software|rent|transport|internet|tax|other",
  "description": "–∫–æ—Ä–æ—Ç–∫–æ",
  "date": "YYYY-MM-DD"
}
`.trim();

// =============== AI ENRICH ===============
async function enrichLineWithAI(line, defaults) {
  const saidWithVAT = /–∑\s*–ø–¥[–≤–≤]/i.test(line.raw + " " + line.rest);
  const saidWithoutVAT = /–±–µ–∑\s*–ø–¥[–≤–≤]/i.test(line.raw + " " + line.rest);

  const prompt = `–†—è–¥–æ–∫: ${line.raw}. –í–∞–ª—é—Ç–∞: ${defaults.currency}, —Å—Ç–∞–≤–∫–∞ –ü–î–í: ${defaults.vatRate}%`;
  const r = await axios.post(
    "https://api.openai.com/v1/chat/completions",
    {
      model: "gpt-4o-mini",
      temperature: 0.1,
      response_format: { type: "json_object" },
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: prompt },
      ],
    },
    {
      headers: { Authorization: `Bearer ${OPENAI_API_KEY}` },
      timeout: 20000,
    }
  );

  let data = {};
  try {
    data = JSON.parse(r.data.choices?.[0]?.message?.content || "{}");
  } catch {}

  let amount_type = data.amount_type || "unknown";
  let vat_applicable =
    typeof data.vat_applicable === "boolean" ? data.vat_applicable : null;

  // —Ä—É—á–Ω—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ
  if (saidWithVAT) {
    vat_applicable = true;
    amount_type = "gross";
  }
  if (saidWithoutVAT) {
    vat_applicable = false;
    amount_type = "net";
  }

  if (line.type === "income") {
    if (vat_applicable === null) vat_applicable = true;
    if (amount_type === "unknown") amount_type = "gross";
  } else {
    if (vat_applicable === null) vat_applicable = true;
    if (amount_type === "unknown") amount_type = vat_applicable ? "gross" : "net";
  }

  const vat_rate = vat_applicable ? defaults.vatRate : 0;
  const category = data.category || "other";
  const description = data.description || line.rest || "";
  const explicit = detectExplicitDate(line.raw) || detectExplicitDate(line.rest);
  const date = explicit ? toISO(explicit) : toISO();
  const currency = (line.currency || defaults.currency).toUpperCase();

  const { net, vat, gross } = computeTriplet(
    line.amount,
    amount_type,
    vat_rate,
    vat_applicable
  );

  const type = line.type;
  const vat_collected = type === "income" ? vat : 0;
  const vat_deductible = type === "expense" && vat_applicable ? vat : 0;

  return {
    type,
    category,
    description,
    date,
    currency,
    net,
    vat,
    gross,
    vat_collected,
    vat_deductible,
  };
}

// =============== AGGREGATES ===============
function totals(entries) {
  let incGross = 0,
    expGross = 0,
    incVAT = 0,
    expVAT = 0;
  entries.forEach((e) => {
    if (e.type === "income") {
      incGross += e.gross;
      incVAT += e.vat_collected;
    } else {
      expGross += e.gross;
      expVAT += e.vat_deductible;
    }
  });
  const profitGross = +(incGross - expGross).toFixed(2);
  const vatDue = +(incVAT - expVAT).toFixed(2);
  const netAfterVAT = +(profitGross - vatDue).toFixed(2);
  return { incGross, expGross, incVAT, expVAT, profitGross, vatDue, netAfterVAT };
}
function vatTotalsMonth(entries, yyyymm) {
  return totals(entries.filter((e) => monthOf(e.date) === yyyymm));
}
function vatTotalsYear(entries, yyyy) {
  return totals(entries.filter((e) => yearOf(e.date) === yyyy));
}

// =============== ROUTES ===============
app.post("/webhook", async (req, res) => {
  try {
    const update = req.body;
    if (!update.message) return res.sendStatus(200);
    const chatId = update.message.chat.id;
    const text = (update.message.text || "").trim();
    const state = getState(chatId);

    if (text === "/start") {
      await tg("sendMessage", {
        chat_id: chatId,
        parse_mode: "Markdown",
        text: `üëã –ü—Ä–∏–≤—ñ—Ç! –Ø *–ü–î–í-–±–æ—Ç*.

–í–≤–æ–¥—å –∫–æ—Ä–æ—Ç–∫—ñ –∑–∞–ø–∏—Å–∏:
‚Ä¢ –î–æ—Ö–æ–¥–∏: \`+1000 –∑ –ü–î–í\`
‚Ä¢ –í–∏—Ç—Ä–∞—Ç–∏: \`-200 —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç –±–µ–∑ –ü–î–í\`

–ö–æ–º–∞–Ω–¥–∏:
/balance ‚Äî –ó–∞–≥–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –¥–æ—Ö–æ–¥—É
/vatmonth [YYYY-MM] ‚Äî –ü—ñ–¥—Å—É–º–æ–∫ –ü–î–í –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π –∞–±–æ –≤–∫–∞–∑–∞–Ω–∏–π –º—ñ—Å—è—Ü—å (/vatmonth 2025-09)
/vatyear [YYYY] ‚Äî –ü—ñ–¥—Å—É–º–æ–∫ –ü–î–í –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π –∞–±–æ –≤–∫–∞–∑–∞–Ω–∏–π —Ä—ñ–∫ (/vatyear 2025)
/reset ‚Äî –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –¥–∞–Ω—ñ`,
      });
      return res.sendStatus(200);
    }

    if (text === "/reset") {
      state.entries = [];
      await tg("sendMessage", { chat_id: chatId, text: "‚úÖ –î–∞–Ω—ñ –æ—á–∏—â–µ–Ω–æ" });
      return res.sendStatus(200);
    }

    // ===== /balance (–∑–∞–º—ñ—Å—Ç—å /vat), –≤–º—ñ—Å—Ç –Ω–µ–∑–º—ñ–Ω–Ω–∏–π =====
    if (text.startsWith("/balance")) {
      const now = new Date();
      const yyyymm = `${now.getFullYear()}-${String(
        now.getMonth() + 1
      ).padStart(2, "0")}`;
      const yyyy = String(now.getFullYear());
      const M = vatTotalsMonth(state.entries, yyyymm);
      const Y = vatTotalsYear(state.entries, yyyy);

      const msg = `
üìä *–ú—ñ—Å—è—Ü—å ${yyyymm}*
‚Äî –û–±–æ—Ä–æ—Ç: –¥–æ—Ö–æ–¥–∏ ${M.incGross} ‚àí –≤–∏—Ç—Ä–∞—Ç–∏ ${M.expGross} = *${M.profitGross}*
‚Äî –ü–î–í: –∑—ñ–±—Ä–∞–Ω–æ ${M.incVAT} ‚àí —Å–ø–ª–∞—á–µ–Ω–æ ${M.expVAT} = *${M.vatDue}*
‚Äî –ß–∏—Å—Ç–∏–π –ø—ñ—Å–ª—è –ü–î–í: *${M.netAfterVAT}*

üìä *–†—ñ–∫ ${yyyy}*
‚Äî –û–±–æ—Ä–æ—Ç: –¥–æ—Ö–æ–¥–∏ ${Y.incGross} ‚àí –≤–∏—Ç—Ä–∞—Ç–∏ ${Y.expGross} = *${Y.profitGross}*
‚Äî –ü–î–í: –∑—ñ–±—Ä–∞–Ω–æ ${Y.incVAT} ‚àí —Å–ø–ª–∞—á–µ–Ω–æ ${Y.expVAT} = *${Y.vatDue}*
‚Äî –ß–∏—Å—Ç–∏–π –ø—ñ—Å–ª—è –ü–î–í: *${Y.netAfterVAT}*
`.trim();
      await tg("sendMessage", { chat_id: chatId, text: msg, parse_mode: "Markdown" });
      return res.sendStatus(200);
    }

    // ===== /vatmonth [YYYY-MM] =====
    if (text.startsWith("/vatmonth")) {
      const m = text.match(/^\/vatmonth(?:\s+(\d{4}-\d{2}))?$/i);
      let yyyymm;
      if (m && m[1]) {
        yyyymm = m[1];
      } else {
        const now = new Date();
        yyyymm = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
      }
      const M = vatTotalsMonth(state.entries, yyyymm);
      // –ü–æ–∫–∞–∑—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π –ø–æ–¥–∞—Ç–æ–∫ (–ü–î–í –¥–æ —Å–ø–ª–∞—Ç–∏)
      await tg("sendMessage", {
        chat_id: chatId,
        parse_mode: "Markdown",
        text: `üí∞ *–ü–î–í –∑–∞ ${yyyymm}:* *${M.vatDue}*`,
      });
      return res.sendStatus(200);
    }

    // ===== /vatyear [YYYY] =====
    if (text.startsWith("/vatyear")) {
      const m = text.match(/^\/vatyear(?:\s+(\d{4}))?$/i);
      let yyyy;
      if (m && m[1]) {
        yyyy = m[1];
      } else {
        const now = new Date();
        yyyy = String(now.getFullYear());
      }
      const Y = vatTotalsYear(state.entries, yyyy);
      // –ü–æ–∫–∞–∑—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π –ø–æ–¥–∞—Ç–æ–∫ (–ü–î–í –¥–æ —Å–ø–ª–∞—Ç–∏)
      await tg("sendMessage", {
        chat_id: chatId,
        parse_mode: "Markdown",
        text: `üí∞ *–ü–î–í –∑–∞ ${yyyy} —Ä—ñ–∫:* *${Y.vatDue}*`,
      });
      return res.sendStatus(200);
    }

    // add lines
    const lines = quickLines(text);
    if (lines.length === 0) {
      await tg("sendMessage", {
        chat_id: chatId,
        text: "‚ö†Ô∏è –§–æ—Ä–º–∞—Ç: `+1000 eur –∑ –ü–î–í` –∞–±–æ `-200 —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç –±–µ–∑ –ü–î–í`",
        parse_mode: "Markdown",
      });
      return res.sendStatus(200);
    }

    const added = [];
    for (const line of lines) {
      const entry = await enrichLineWithAI(line, state.settings);
      state.entries.push(entry);
      added.push(entry);
    }

    const now = new Date();
    const yyyymm = `${now.getFullYear()}-${String(
      now.getMonth() + 1
    ).padStart(2, "0")}`;
    const yyyy = String(now.getFullYear());
    const M = vatTotalsMonth(state.entries, yyyymm);
    const Y = vatTotalsYear(state.entries, yyyy);

// ‚Äî‚Äî‚Äî APPLE-STYLE / ELEGANT MESSAGING ‚Äî‚Äî‚Äî
const num = (n) => Number(n || 0).toFixed(2);
const nbsp = "\u00A0";
const thinsp = "\u202F";

const dot = "¬∑";
const hrBold = "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ";
const hrSoft = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";

const boxTop    = "‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ";
const boxMid    = "‚îÇ";
const boxBottom = "‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ";

const money = (amount, ccy = "‚Ç¨") => `${ccy}${thinsp}${num(amount)}`;

// ‚Äî‚Äî‚Äî Pills / Badges
const pill = (text, tone = "neutral") => {
  const toneMap = {
    good:  "üü¢",
    bad:   "üî¥",
    warn:  "üü°",
    info:  "üî∑",
    neutral: "‚ö™Ô∏è",
  };
  return `${toneMap[tone] || toneMap.neutral}${nbsp}${text}`;
};

// ‚Äî‚Äî‚Äî Labeled line (consistent pattern)
const line = (emoji, label, value, boldValue = false) =>
  `${emoji}${nbsp}${label}${nbsp}‚Äî${nbsp}${boldValue ? `*${value}*` : value}`;

// ‚Äî‚Äî‚Äî Entry cards
const entryCards = (added && added.length)
  ? added.map((e) => {
      const isInc = e.type === "income";
      const badge = isInc ? pill("–î–æ—Ö—ñ–¥", "good") : pill("–í–∏—Ç—Ä–∞—Ç–∞", "bad");
      const ccy = e.currency || "‚Ç¨";

      const body = [
        // header row
        `${badge}${nbsp}${dot}${nbsp}${e.date}`,
        line("üí∂", "–°—É–º–∞",          money(e.gross, ccy), true),
        line("üßæ", "–ü–î–í",           money(e.vat, ccy)),
        line("üìÇ", "–ö–∞—Ç–µ–≥–æ—Ä—ñ—è",     e.category || "‚Äî"),
        line("‚úçÔ∏è", "–û–ø–∏—Å",          e.description || "‚Äî"),
      ];

      return [
        boxTop,
        `${boxMid} ${body[0].padEnd(26, " ")} ${boxMid}`,
        `${boxMid} ${body[1].padEnd(26, " ")} ${boxMid}`,
        `${boxMid} ${body[2].padEnd(26, " ")} ${boxMid}`,
        `${boxMid} ${body[3].padEnd(26, " ")} ${boxMid}`,
        `${boxMid} ${body[4].padEnd(26, " ")} ${boxMid}`,
        boxBottom,
      ].join("\n");
    }).join(`\n\n`)
  : "_(–ó–∞–ø–∏—Å—ñ–≤ –Ω–µ –¥–æ–¥–∞–Ω–æ)_";

// ‚Äî‚Äî‚Äî Summary block (Month / Year)
const makeSummaryBox = (titleEmoji, titleText, S, showNetCaption = "–ß–∏—Å—Ç–∏–π –ø—ñ—Å–ª—è –ü–î–í") => {
  const rows = [
    `${titleEmoji}${nbsp}*${titleText}*`,
    line("üì•", "–î–æ—Ö—ñ–¥",     money(S.incGross), true),
    line("üì§", "–í–∏—Ç—Ä–∞—Ç–∏",   money(S.expGross), true),
    hrSoft,
    line("üíº", "–ü—Ä–∏–±—É—Ç–æ–∫",  money(S.profitGross), true),
    hrSoft,
    line("üü¢", "–ó—ñ–±—Ä–∞–Ω–æ –ü–î–í", money(S.incVAT)),
    line("üî¥", "–°–ø–ª–∞—á–µ–Ω–æ –ü–î–í", money(S.expVAT)),
    line("‚öñÔ∏è", "–î–æ —Å–ø–ª–∞—Ç–∏ –ü–î–í", money(S.vatDue), true),
    line("‚úÖ", showNetCaption, money(S.netAfterVAT), true),
  ];

  return [
    boxTop,
    `${boxMid} ${rows[0].padEnd(26, " ")} ${boxMid}`,
    `${boxMid} ${rows[1].padEnd(26, " ")} ${boxMid}`,
    `${boxMid} ${rows[2].padEnd(26, " ")} ${boxMid}`,
    `${boxMid} ${"".padEnd(26, "‚îÄ")} ${boxMid}`,
    `${boxMid} ${rows[4].padEnd(26, " ")} ${boxMid}`,
    `${boxMid} ${"".padEnd(26, "‚îÄ")} ${boxMid}`,
    `${boxMid} ${rows[6].padEnd(26, " ")} ${boxMid}`,
    `${boxMid} ${rows[7].padEnd(26, " ")} ${boxMid}`,
    `${boxMid} ${rows[8].padEnd(26, " ")} ${boxMid}`,
    `${boxMid} ${rows[9].padEnd(26, " ")} ${boxMid}`,
    boxBottom,
  ].join("\n");
};

// ‚Äî‚Äî‚Äî Build message
const monthBox = makeSummaryBox("üìä", yyyymm, M, "–ß–∏—Å—Ç–∏–π –ø—ñ—Å–ª—è –ü–î–í");
const yearBox  = makeSummaryBox("üìà", String(yyyy), Y, "–ß–∏—Å—Ç–∏–π –ø—Ä–∏–±—É—Ç–æ–∫ –ø—ñ—Å–ª—è –ü–î–í");

const header = [
  "‚úÖ *–ó–∞–ø–∏—Å–∏ –¥–æ–¥–∞–Ω–æ*",
  hrBold,
].join("\n");

const message = [
  header,
  entryCards,
  "",
  monthBox,
  "",
  yearBox
].join("\n");

try {
  await tg("sendMessage", {
    chat_id: chatId,
    text: message,
    parse_mode: "Markdown",
  });
} catch (err) {
  console.error("‚ùå sendMessage error:", err?.response?.data || err?.message || err);
}



    res.sendStatus(200);
  } catch (err) {
    console.error("Webhook error:", err?.response?.data || err.message);
    res.sendStatus(200);
  }
});

app.listen(PORT, () => console.log("üöÄ VAT bot running on port " + PORT));
